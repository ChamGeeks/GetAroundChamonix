!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.GeoTree=t()}}(function(){return function t(e,r,n){function o(a,l){if(!r[a]){if(!e[a]){var f="function"==typeof require&&require;if(!l&&f)return f(a,!0);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var u=r[a]={exports:{}};e[a][0].call(u.exports,function(t){var r=e[a][1][t];return o(r?r:t)},u,u.exports,t,e,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(t,e){function r(t,e,r){function n(t){return 180*t/Math.PI}function o(t){return t*Math.PI/180}for(var i=6371009,a=[{units:"m",ratio:1},{units:"km",ratio:1e3},{units:"yd",ratio:.9144},{units:"mi",ratio:1609.34}],l=0;l<a.length&&a[l].units!==r;l++);if(a.length===l){var f=e*e;return{angle:e,validate:function(e){var r=t.lat-e.lat,n=t.lng-e.lng;return f>=r*r+n*n}}}var u=e*a[l].ratio;return{angle:n(u/(i*Math.cos(o(t.lat)))),validate:function(e){var r=o(t.lat-e.lat),n=o(t.lng-e.lng),a=Math.sin(r/2),l=Math.sin(n/2),f=Math.cos(o(t.lat)),h=Math.cos(o(e.lat)),s=a*a+f*h*l*l,p=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return u>=i*p}}}function n(){this.tree=new o}var o=t("./red-black"),i=t("./z-curve");n.prototype.insert=function(t,e,r){var n,o,a;if("number"==typeof t)n=t,o=e,a=r;else{if("object"!=typeof t)return;if("number"==typeof t.length){for(var l=0;l<t.length;l++)this.insert(t[l]);return}n=t.lat,o=t.lng,a=t.data}var f=Math.round(1e5*(n+90)),u=Math.round(1e5*(o+180)),h=i.xy2d(f,u);this.tree.insert(h,{idx:h,lat:n,lng:o,data:a})},n.prototype.find=function(t,e,n){var o,a,l;if(o=0===arguments.length,void 0===e&&(e=t),"number"==typeof e){var f=r(t,e,n);a=f.angle,l=f.validate}var u,h,s,p,g=-1/0,c=1/0;o||(void 0===a?(u=Math.min(t.lat,e.lat),h=Math.max(t.lat,e.lat),s=Math.min(t.lng,e.lng),p=Math.max(t.lng,e.lng)):(u=Math.max(t.lat-a,-90),h=Math.min(t.lat+a,90),s=Math.max(t.lng-a,-180),p=Math.min(t.lng+a,180)),g=i.xy2d(Math.round(1e5*(u+90)),Math.round(1e5*(s+180))),c=i.xy2d(Math.round(1e5*(h+90)),Math.round(1e5*(p+180))));var d,v,y,m,M=this.tree.find(g,c),k=[];if(o)for(d=0;d<M.length;d++)k.push(M[d].data);else if(void 0===a)for(d=0;d<M.length;d++)v=M[d],y=v.lat,m=v.lng,y>=u&&h>=y&&m>=s&&p>=m&&k.push(v.data);else for(d=0;d<M.length;d++)v=M[d],l(v)&&k.push(v.data);return k},n.prototype.forEach=function(t){t&&this.tree.forEach(function(e){t(e.data)})},n.prototype.dump=function(t){return this.tree.dump(t)},e.exports=n},{"./red-black":2,"./z-curve":3}],2:[function(t,e){function r(t,e,r){this.parent=t,this.key=e,this.values=[r],this.left=null,this.right=null,this.color=o}function n(){this.root=null}var o=0,i=1;r.prototype.getGrand=function(){return this.parent?this.parent.parent:null},r.prototype.getUncle=function(){var t=this.getGrand();return t?t.left===this.parent?t.right:t.left:null},r.prototype.dump=function(){return"[k:"+this.key+",c:"+(o===this.color?"R":"B")+",#:"+this.values.length+",l:"+(this.left?this.left.key:"NULL")+",r:"+(this.right?this.right.key:"NULL")+",p:"+(this.parent?this.parent.key:"NULL")+",v:"+JSON.stringify(this.values)+"]"},n.prototype.insert=function(t,e){if("number"==typeof t)this._insert(t,e);else if("object"==typeof t)if("number"==typeof t.length)for(var r,n=0;n<t.length;n++)r=t[n],this._insert(r.key,r.value);else this._insert(t.key,t.value)},n.prototype._insert=function(t,e){var n,a,l,f,u;if(this.root)for(a=this.root;;){if(a.key===t)return void a.values.push(e);if(t<a.key){if(!a.left){n=a.left=new r(a,t,e);break}a=a.left}else{if(!a.right){n=a.right=new r(a,t,e);break}a=a.right}}else n=this.root=new r(null,t,e);for(l=n.getGrand(),f=n.getUncle();;){if(!a){n.color=i;break}if(i===a.color)break;{if(!f||o!==f.color){n===a.right&&a===l.left?(l.left=n,n.parent=l,(a.right=n.left)&&(n.left.parent=a),n.left=a,a.parent=n,n=a,a=n.parent):n===a.left&&a===l.right&&(l.right=n,n.parent=l,(a.left=n.right)&&(n.right.parent=a),n.right=a,a.parent=n,n=a,a=n.parent),a.color=i,l.color=o,n===a.left?((l.left=a.right)&&(a.right.parent=l),a.right=l):((l.right=a.left)&&(a.left.parent=l),a.left=l),u=l.parent,u?l===u.left?u.left=a:u.right=a:(this.root=a,a.color=i),a.parent=u,l.parent=a;break}a.color=f.color=i,l.color=o,n=l,a=n.parent,l=n.getGrand(),f=n.getUncle()}}},n.prototype.find=function(t,e){if(!this.root)return[];void 0===e&&(e=t);for(var r,n=[],o=[this.root];o.length;)r=o.pop(),r.key>=t&&r.key<=e&&n.push(r.values),r.right&&r.key<e&&o.push(r.right),r.left&&r.key>t&&o.push(r.left);var i,a,l,f=[];for(i=0;i<n.length;i++)for(l=n[i],a=0;a<l.length;a++)f.push(l[a]);return f},n.prototype.forEach=function(t){function e(r){if(r){e(r.left);for(var n=r.values,o=r.key,i=0;i<n.length;i++)t(n[i],o);e(r.right)}}t&&e(this.root)},n.prototype.dump=function(t){function e(n,o){if(n){t?r+=n.dump():console.log((void 0!==o?o+"+ ":"")+n.dump());var i=void 0===o?"":o+"  ";e(n.left,i),e(n.right,i)}}var r="";return t||console.log("--- dump start ---"),e(this.root),t||console.log("--- dump end ---"),r},e.exports=n},{}],3:[function(t,e){e.exports={xy2d:function(t,e){for(var r=1,n=Math.max(t,e),o=0;n>=r;)r<<=1;for(r>>=1;r;)o*=2,t&r&&(o+=1),o*=2,e&r&&(o+=1),r>>=1;return o}}},{}]},{},[1])(1)});